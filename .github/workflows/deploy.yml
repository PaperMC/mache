name: Deploy
on:
  push:
    branches:
      - 'ver/*'
      - 'snap/*'
    paths:
      - 'versions/*/patches/**'
      - 'versions/*/build.gradle.kts'
  workflow_dispatch:

jobs:
  # Only run if all dependencies are release versions
  # SNAPSHOT versions are unstable, which would make our published artifact unstable
  verify:
    name: Verify
    runs-on: ubuntu-latest
    # Guard against manual runs on the wrong branch
    if: startsWith(github.ref, 'refs/heads/ver/') || startsWith(github.ref, 'refs/heads/snap/')
    steps:
      - uses: actions/checkout@v4
      - uses: gradle/wrapper-validation-action@v2
      - name: Check Automated
        id: automated
        shell: bash
        run: |
          if [[ "$(git log -1 --format=format:%ae)" == "sculptor@automated.papermc.io" ]]; then
              echo "was_automated=true" >> $GITHUB_OUTPUT
          else
              echo "was_automated=false" >> $GITHUB_OUTPUT
          fi
      - name: Version Name
        id: version
        shell: bash
        run: |
          version="${GITHUB_REF_NAME##*/}"
          formatted_version=$(echo "v${version}" | sed 's/\./_/g')
          echo "folder_name=${version}" >> $GITHUB_OUTPUT
          echo "project_name=${formatted_version}" >> $GITHUB_OUTPUT
      - name: Verify Dependencies
        id: verify_deps
        shell: bash
        run: |
          if [[ "$(grep -i -- '-SNAPSHOT' versions/${{ steps.version.outputs.folder_name }}/build.gradle.kts | wc -l)" -eq "0" ]] ; then
            echo "all_release=true" >> $GITHUB_OUTPUT
          else
            echo "all_release=false" >> $GITHUB_OUTPUT
            echo '⚠️ Not releasing since build.gradle.kts contains snapshots!' >> $GITHUB_STEP_SUMMARY
          fi
    outputs:
      folder_name: ${{ steps.version.outputs.folder_name }}
      project_name: ${{ steps.version.outputs.project_name }}
      deps_all_release: ${{ steps.verify_deps.outputs.all_release }}
      was_automated: ${{ steps.automated.outputs.was_automated }}
  applyPatches:
    name: Apply Patches
    runs-on: ubuntu-latest
    needs: verify
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
      - uses: gradle/wrapper-validation-action@v2
        name: Validate Gradle Wrapper
      - uses: gradle/actions/setup-gradle@v3
        name: Setup Gradle
      - name: Apply Patches
        id: apply_patches
        run: |
          set +e
          ./gradlew ':versions:${{ needs.verify.outputs.project_name }}:applyPatches' --no-daemon
          exitcode="$?"
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
          exit "$exitcode"
      - uses: Tiryoh/gha-jobid-action@v1
        id: jobs
        if: needs.verify.outputs.was_automated && failure() && steps.apply_patches.outputs.exitcode != 0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          job_name: "Apply Patches"
      - name: Create Failure Issue
        if: needs.verify.outputs.was_automated && failure() && steps.apply_patches.outputs.exitcode != 0
        run: |
          set +e
          gh issue list --state open --label update --json title | jq '.[].title' | cut -c2- | rev | cut -c2- | rev | cut -d' ' -f4 | grep "${{ needs.verify.outputs.folder_name }}"
          if [[ "$?" -ne "0" ]]; then
            set -e
            gh issue create \
              --title "Failed to apply patches for ${{ needs.verify.outputs.folder_name }}" \
              --body "Failed to apply patches for ${{ needs.verify.outputs.folder_name }}. Please check the [logs](${{ steps.jobs.outputs.html_url }}) for more information." \
              --label update
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      - name: Tar sources
        run: tar --exclude '*/.git*' -cf sources.tar versions/${{ needs.verify.outputs.folder_name }}/src/
      - uses: actions/upload-artifact@v4
        name: Archive patched sources
        with:
          name: patched-sources
          path: sources.tar
          if-no-files-found: error
          retention-days: 1
  # We will only attempt to deploy an artifact if the current version config successfully compiles
  # Note: We don't publish the sources or build output, this only validates that it _does_ build
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [verify, applyPatches]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
      - uses: actions/download-artifact@v4
        with:
          name: patched-sources
          path: sources
      - name: Extract sources
        run: tar -xf sources/sources.tar versions/${{ needs.verify.outputs.folder_name }}/src/ && rm -r sources/
      - uses: gradle/wrapper-validation-action@v2
        name: Validate Gradle Wrapper
      - uses: gradle/actions/setup-gradle@v3
        name: Setup Gradle
      - name: Build Server
        id: build_server
        run: |
          set +e
          ./gradlew ':versions:${{ needs.verify.outputs.project_name }}:build' --no-daemon
          exitcode="$?"
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
          exit "$exitcode"
      - uses: Tiryoh/gha-jobid-action@v1
        id: jobs
        if: needs.verify.outputs.was_automated && failure() && steps.build_server.outputs.exitcode != 0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          job_name: Build
      - name: Create Failure Issue
        if: needs.verify.outputs.was_automated && failure() && steps.build_server.outputs.exitcode != 0
        run: |
          set +e
          gh issue list --state open --label update --json title | jq '.[].title' | cut -c2- | rev | cut -c2- | rev | cut -d' ' -f4 | grep ${{ needs.verify.outputs.folder_name }}
          if [[ "$?" -ne "0" ]]; then
            set -e
            gh issue create \
            --title "Failed to build ${{ needs.verify.outputs.folder_name }}" \
            --body "Failed to build ${{ needs.verify.outputs.folder_name }}. Please check the [logs](${{ steps.jobs.outputs.html_url }}) for more information." \
            --label update
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [verify, build]
    if: needs.verify.outputs.deps_all_release == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
      - uses: gradle/wrapper-validation-action@v2
        name: Validate Gradle Wrapper
      - uses: gradle/actions/setup-gradle@v3
        name: Setup Gradle
      - name: Deploy Mache Artifact
        run: ./gradlew ':versions:${{ needs.verify.outputs.project_name }}:publishMachePublicationToPaperMCRepository'
        env:
          BUILD_ID: ${{ env.GITHUB_RUN_NUMBER }}
          ORG_GRADLE_PROJECT_PaperMCUsername: ${{ secrets.NEXUS_USERNAME }}
          ORG_GRADLE_PROJECT_PaperMCPassword: ${{ secrets.NEXUS_PASSWORD }}
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [verify, applyPatches, build, deploy]
    if: always()
    steps:
      - uses: geekyeggo/delete-artifact@v5
        with:
          name: patched-sources
